


<ul>
<li><a class="reference internal" href="#">Dispatching Controllers</a><ul>
<li><a class="reference internal" href="#the-dispatch-loop">The Dispatch Loop</a><ul>
<li><a class="reference internal" href="#dispatch-loop-events">Dispatch Loop Events</a></li>
</ul>
</li>
<li><a class="reference internal" href="#forwarding-to-other-actions">Forwarding to other actions</a></li>
<li><a class="reference internal" href="#getting-parameters">Getting Parameters</a></li>
<li><a class="reference internal" href="#handling-not-found-exceptions">Handling Not-Found Exceptions</a></li>
<li><a class="reference internal" href="#implementing-your-own-dispatcher">Implementing your own Dispatcher</a></li>
</ul>
</li>
</ul>


  <div class="section" id="dispatching-controllers">
<h1>Dispatching Controllers<a class="headerlink" href="#dispatching-controllers" title="Ссылка на этот заголовок">¶</a></h1>
<p><tt class="xref doc docutils literal"><span class="pre">Phalcon\Mvc\Dispatcher</span></tt> is the component responsible of instantiate controllers and execute the required actions
on them in an MVC application. Understand its operation and capabilities helps us get more out of the services provided by the framework.</p>
<div class="section" id="the-dispatch-loop">
<h2>The Dispatch Loop<a class="headerlink" href="#the-dispatch-loop" title="Ссылка на этот заголовок">¶</a></h2>
<p>This is an important process that has much to do with the MVC flow itself, especially with the controller part. The work occurs within the controller
dispatcher. The controller files are read, loaded, instantiated, to then the required actions are executed. If an action forwards the flow to another
controller/action, the controller dispatcher starts again. To better illustrate this, the following example shows approximately the process performed
within <tt class="xref doc docutils literal"><span class="pre">Phalcon\Mvc\Dispatcher</span></tt>:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Dispatch loop</span>
<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nv">$finished</span><span class="p">)</span> <span class="p">{</span>

    <span class="nv">$finished</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

    <span class="nv">$controllerClass</span> <span class="o">=</span> <span class="nv">$controllerName</span> <span class="o">.</span> <span class="s2">&quot;Controller&quot;</span><span class="p">;</span>

    <span class="c1">//Instantiating the controller class via autoloaders</span>
    <span class="nv">$controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$controllerClass</span><span class="p">();</span>

    <span class="c1">// Execute the action</span>
    <span class="nb">call_user_func_array</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$controller</span><span class="p">,</span> <span class="nv">$actionName</span> <span class="o">.</span> <span class="s2">&quot;Action&quot;</span><span class="p">),</span> <span class="nv">$params</span><span class="p">);</span>

    <span class="c1">// &#39;$finished&#39; should be reloaded to check if the flow</span>
    <span class="c1">// was forwarded to another controller</span>
    <span class="nv">$finished</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The code above lacks validations, filters and additional checks, but it demonstrates the normal flow of operation in the dispatcher.</p>
<div class="section" id="dispatch-loop-events">
<h3>Dispatch Loop Events<a class="headerlink" href="#dispatch-loop-events" title="Ссылка на этот заголовок">¶</a></h3>
<p><tt class="xref doc docutils literal"><span class="pre">Phalcon\Mvc\Dispatcher</span></tt> is able to send events to an <a class="reference internal" href="events.html"><em>EventsManager</em></a> if it is present. Events are triggered using the type &#8220;dispatch&#8221;. Some events when returning boolean false could stop the active operation. The following events are supported:</p>
<table border="1" class="docutils">
<colgroup>
<col width="9%" />
<col width="83%" />
<col width="8%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Event Name</th>
<th class="head">Triggered</th>
<th class="head">Can stop operation?</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>beforeDispatchLoop</td>
<td>Triggered before entering in the dispatch loop. At this point the dispatcher don&#8217;t know if the controller or the actions to be executed exist. The Dispatcher only knows the information passed by the Router.</td>
<td>Yes</td>
</tr>
<tr class="row-odd"><td>beforeDispatch</td>
<td>Triggered after entering in the dispatch loop. At this point the dispatcher don&#8217;t know if the controller or the actions to be executed exist. The Dispatcher only knows the information passed by the Router.</td>
<td>Yes</td>
</tr>
<tr class="row-even"><td>beforeExecuteRoute</td>
<td>Triggered before executing the controller/action method. At this point the dispatcher has been initialized the controller and know if the action exist.</td>
<td>Yes</td>
</tr>
<tr class="row-odd"><td>afterExecuteRoute</td>
<td>Triggered after executing the controller/action method. As operation cannot be stopped, only use this event to make clean up after execute the action</td>
<td>No</td>
</tr>
<tr class="row-even"><td>beforeNotFoundAction</td>
<td>Triggered when the action was not found in the controller</td>
<td>Yes</td>
</tr>
<tr class="row-odd"><td>beforeException</td>
<td>Triggered before the dispatcher throws any exception</td>
<td>Yes</td>
</tr>
<tr class="row-even"><td>afterDispatch</td>
<td>Triggered after executing the controller/action method. As operation cannot be stopped, only use this event to make clean up after execute the action</td>
<td>Yes</td>
</tr>
<tr class="row-odd"><td>afterDispatchLoop</td>
<td>Triggered after exiting the dispatch loop</td>
<td>No</td>
</tr>
</tbody>
</table>
<p>The <a class="reference internal" href="tutorial-invo.html"><em>INVO</em></a> tutorial shows how to take advantage of dispatching events implementing a security filter with <a class="reference internal" href="acl.html"><em>Acl</em></a></p>
<p>The following example demonstrates how to attach listeners to this component:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;dispatcher&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">(){</span>

    <span class="c1">//Create an event manager</span>
    <span class="nv">$eventsManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Events\Manager</span><span class="p">();</span>

    <span class="c1">//Attach a listener for type &quot;dispatch&quot;</span>
    <span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="s2">&quot;dispatch&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="nv">$event</span><span class="p">,</span> <span class="nv">$dispatcher</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">});</span>

    <span class="nv">$dispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Phalcon\Mvc\Dispatcher</span><span class="p">();</span>

    <span class="c1">//Bind the eventsManager to the view component</span>
    <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">setEventsManager</span><span class="p">(</span><span class="nv">$eventsManager</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$dispatcher</span><span class="p">;</span>

<span class="p">},</span> <span class="k">true</span><span class="p">);</span>
</pre></div>
</div>
<p>An instantiated controller automatically acts as a listener for dispatch events, so you can implement methods as callbacks:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">PostsController</span> <span class="k">extends</span> <span class="nx">\Phalcon\Mvc\Controller</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeExecuteRoute</span><span class="p">(</span><span class="nv">$dispatcher</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Executed before every found action</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">afterExecuteRoute</span><span class="p">(</span><span class="nv">$dispatcher</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Executed after every found action</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="forwarding-to-other-actions">
<h2>Forwarding to other actions<a class="headerlink" href="#forwarding-to-other-actions" title="Ссылка на этот заголовок">¶</a></h2>
<p>The dispatch loop allows us to forward the execution flow to another controller/action. This is very useful to check if the user can
access to certain options, redirect users to other screens or simply reuse code.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">PostsController</span> <span class="k">extends</span> <span class="nx">\Phalcon\Mvc\Controller</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">indexAction</span><span class="p">()</span>
    <span class="p">{</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">saveAction</span><span class="p">(</span><span class="nv">$year</span><span class="p">,</span> <span class="nv">$postTitle</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="c1">// .. store some product and forward the user</span>

        <span class="c1">// Forward flow to the index action</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dispatcher</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="s2">&quot;controller&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span>
            <span class="s2">&quot;action&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;index&quot;</span>
        <span class="p">));</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Keep in mind that making a &#8220;forward&#8221; is not the same as making an HTTP redirect. Although they apparently got the same result.
The &#8220;forward&#8221; doesn&#8217;t reload the current page, all the redirection occurs in a single request, while the HTTP redirect needs two requests
to complete the process.</p>
<p>More forwarding examples:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Forward flow to another action in the current controller</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dispatcher</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s2">&quot;action&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;search&quot;</span>
<span class="p">));</span>

<span class="c1">// Forward flow to another action in the current controller</span>
<span class="c1">// passing parameters</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dispatcher</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s2">&quot;action&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;search&quot;</span><span class="p">,</span>
    <span class="s2">&quot;params&quot;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">));</span>
</pre></div>
</div>
<p>A forward action accepts the following parameters:</p>
<table border="1" class="docutils">
<colgroup>
<col width="22%" />
<col width="78%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parameter</th>
<th class="head">Triggered</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>controller</td>
<td>A valid controller name to forward to.</td>
</tr>
<tr class="row-odd"><td>action</td>
<td>A valid action name to forward to.</td>
</tr>
<tr class="row-even"><td>params</td>
<td>An array of parameters for the action</td>
</tr>
<tr class="row-odd"><td>namespace</td>
<td>A valid namespace name where the controller is part of</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="getting-parameters">
<h2>Getting Parameters<a class="headerlink" href="#getting-parameters" title="Ссылка на этот заголовок">¶</a></h2>
<p>When a route provides named parameters you can receive them in a controller, a view or any other component that extends
<tt class="xref doc docutils literal"><span class="pre">Phalcon\DI\Injectable</span></tt>.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">PostsController</span> <span class="k">extends</span> <span class="nx">\Phalcon\Mvc\Controller</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">indexAction</span><span class="p">()</span>
    <span class="p">{</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">saveAction</span><span class="p">()</span>
    <span class="p">{</span>

        <span class="c1">// Get the post&#39;s title passed in the URL as parameter</span>
        <span class="nv">$title</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dispatcher</span><span class="o">-&gt;</span><span class="na">getParam</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">);</span>

        <span class="c1">// Get the post&#39;s year passed in the URL as parameter</span>
        <span class="c1">// also filtering it</span>
        <span class="nv">$year</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dispatcher</span><span class="o">-&gt;</span><span class="na">getParam</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;int&quot;</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="handling-not-found-exceptions">
<h2>Handling Not-Found Exceptions<a class="headerlink" href="#handling-not-found-exceptions" title="Ссылка на этот заголовок">¶</a></h2>
<p>Using the <a class="reference internal" href="events.html"><em>EventsManager</em></a> it&#8217;s possible to insert a hook point before the dispatcher throws an exception when a controller/action wasn&#8217;t found.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">setShared</span><span class="p">(</span><span class="s1">&#39;dispatcher&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">//Create/Get an EventManager</span>
    <span class="nv">$eventsManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Events\Manager</span><span class="p">();</span>

    <span class="c1">//Attach a listener</span>
    <span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="s2">&quot;dispatch&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="nv">$event</span><span class="p">,</span> <span class="nv">$dispatcher</span><span class="p">,</span> <span class="nv">$exception</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">//The controller exists but the action not</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getType</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;beforeNotFoundAction&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;show404&#39;</span>
            <span class="p">));</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//Alternative way, controller or action doesn&#39;t exist</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getType</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;beforeException&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getCode</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">case</span> <span class="nx">Phalcon\Dispatcher</span><span class="o">::</span><span class="na">EXCEPTION_HANDLER_NOT_FOUND</span><span class="o">:</span>
                <span class="k">case</span> <span class="nx">Phalcon\Dispatcher</span><span class="o">::</span><span class="na">EXCEPTION_ACTION_NOT_FOUND</span><span class="o">:</span>
                    <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                        <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;show404&#39;</span>
                    <span class="p">));</span>
                    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="nv">$dispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Mvc\Dispatcher</span><span class="p">();</span>

    <span class="c1">//Bind the EventsManager to the dispatcher</span>
    <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">setEventsManager</span><span class="p">(</span><span class="nv">$eventsManager</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$dispatcher</span><span class="p">;</span>

<span class="p">},</span> <span class="k">true</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="implementing-your-own-dispatcher">
<h2>Implementing your own Dispatcher<a class="headerlink" href="#implementing-your-own-dispatcher" title="Ссылка на этот заголовок">¶</a></h2>
<p>The <tt class="xref doc docutils literal"><span class="pre">Phalcon\Mvc\DispatcherInterface</span></tt> interface must be implemented to create your own dispatcher
replacing the one provided by Phalcon.</p>
</div>
</div>


