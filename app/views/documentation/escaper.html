


<div class="body">

  <div class="section" id="contextual-escaping">
<h1>Contextual Escaping<a class="headerlink" href="#contextual-escaping" title="Ссылка на этот заголовок">¶</a></h1>
<p>Websites and Web applications are vulnerable to <a class="reference external" href="https://www.owasp.org/index.php/XSS">XSS</a> attacks, despite PHP provides escaping functionality, in some contexts
those are not sufficient/appropriate. <tt class="xref doc docutils literal"><span class="pre">Phalcon\Escaper</span></tt> provides contextual escaping, this component is written in C providing
the minimal overhead when escaping different kinds of texts.</p>
<p>We designed this component based on the <a class="reference external" href="https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet">XSS (Cross Site Scripting) Prevention Cheat Sheet</a> created by the <a class="reference external" href="https://www.owasp.org">OWASP</a></p>
<p>Additionally, this component relies on <a class="reference external" href="http://php.net/manual/en/book.mbstring.php">mbstring</a> to support almost any charset.</p>
<p>To illustrate how this component works and why it is important, consider the following example:</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

    <span class="c1">//Document title with malicious extra HTML tags</span>
    <span class="nv">$maliciousTitle</span> <span class="o">=</span> <span class="s1">&#39;&lt;/title&gt;&lt;script&gt;alert(1)&lt;/script&gt;&#39;</span><span class="p">;</span>

    <span class="c1">//Malicious CSS class name</span>
    <span class="nv">$className</span> <span class="o">=</span> <span class="s1">&#39;;`(&#39;</span><span class="p">;</span>

    <span class="c1">//Malicious CSS font name</span>
    <span class="nv">$fontName</span> <span class="o">=</span> <span class="s1">&#39;Verdana&quot;&lt;/style&gt;&#39;</span><span class="p">;</span>

    <span class="c1">//Malicious Javascript text</span>
    <span class="nv">$javascriptText</span> <span class="o">=</span> <span class="s2">&quot;&#39;;&lt;/script&gt;Hello&quot;</span><span class="p">;</span>

    <span class="c1">//Create an escaper</span>
    <span class="nv">$e</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Escaper</span><span class="p">();</span>

<span class="cp">?&gt;</span>

<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">escapeHtml</span><span class="p">(</span><span class="nv">$maliciousTitle</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="nt">&lt;/title&gt;</span>

    <span class="nt">&lt;style </span><span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
    <span class="o">.</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">escapeCss</span><span class="p">(</span><span class="nv">$className</span><span class="p">)</span> <span class="cp">?&gt;</span> <span class="p">{</span>
        <span class="k">font-family</span>  <span class="o">:</span> <span class="s2">&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">escapeCss</span><span class="p">(</span><span class="nv">$fontName</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="k">color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">&lt;/style&gt;</span>

<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&#39;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">escapeHtmlAttr</span><span class="p">(</span><span class="nv">$className</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="s">&#39;</span><span class="nt">&gt;</span>hello<span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;script&gt;</span><span class="kd">var</span> <span class="nx">some</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">escapeJs</span><span class="p">(</span><span class="nv">$javascriptText</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="s1">&#39;</span><span class="nt">&lt;/script&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>Which produces the following:</p>
<div class="figure align-center">
<img alt="../_images/escape.jpeg" src="../_images/escape.jpeg" />
</div>
<p>Every text was escaped according to its context. Use the appropriate context is important to avoid XSS attacks.</p>
<div class="section" id="escaping-html">
<h2>Escaping HTML<a class="headerlink" href="#escaping-html" title="Ссылка на этот заголовок">¶</a></h2>
<p>The most common situation when inserting unsafe data is between HTML tags:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;comments&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!-- Escape unstrusted data here! --&gt;</span><span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p>You can escape those data using the escapeHtml method:</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;comments&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">escapeHtml</span><span class="p">(</span><span class="s1">&#39;&gt;&lt;/div&gt;&lt;h1&gt;myattack&lt;/h1&gt;&#39;</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p>Which produces:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;comments&quot;</span><span class="nt">&gt;</span><span class="ni">&amp;gt;&amp;lt;</span>/div<span class="ni">&amp;gt;&amp;lt;</span>h1<span class="ni">&amp;gt;</span>myattack<span class="ni">&amp;lt;</span>/h1<span class="ni">&amp;gt;</span><span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="escaping-html-attributes">
<h2>Escaping HTML Attributes<a class="headerlink" href="#escaping-html-attributes" title="Ссылка на этот заголовок">¶</a></h2>
<p>Escape HTML attributes is different from escape a full HTML content. The escape works by changing every non-alphanumeric
character to the form. This kind of escaping is intended to most simpler attributes excluding complex ones like &#8216;href&#8217; or &#8216;url&#8217;:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;table</span> <span class="na">width=</span><span class="s">&quot;Escape unstrusted data here!&quot;</span><span class="nt">&gt;&lt;tr&gt;&lt;td&gt;</span>Hello<span class="nt">&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;</span>
</pre></div>
</div>
<p>You can escape an HTML attribute by using the escapeHtmlAttr method:</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="nt">&lt;table</span> <span class="na">width=</span><span class="s">&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">escapeHtmlAttr</span><span class="p">(</span><span class="s1">&#39;&quot;&gt;&lt;h1&gt;Hello&lt;/table&#39;</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="s">&quot;</span><span class="nt">&gt;&lt;tr&gt;&lt;td&gt;</span>Hello<span class="nt">&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;</span>
</pre></div>
</div>
<p>Which produces:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;table</span> <span class="na">width=</span><span class="s">&quot;&amp;#x22;&amp;#x3e;&amp;#x3c;h1&amp;#x3e;Hello&amp;#x3c;&amp;#x2f;table&quot;</span><span class="nt">&gt;&lt;tr&gt;&lt;td&gt;</span>Hello<span class="nt">&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="escaping-urls">
<h2>Escaping URLs<a class="headerlink" href="#escaping-urls" title="Ссылка на этот заголовок">¶</a></h2>
<p>Some HTML attributes like &#8216;href&#8217; or &#8216;url&#8217; need to be escaped differently:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;Escape unstrusted data here!&quot;</span><span class="nt">&gt;</span>Some link<span class="nt">&lt;/a&gt;</span>
</pre></div>
</div>
<p>You can escape an HTML attribute by using the escapeUrl method:</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">escapeUrl</span><span class="p">(</span><span class="s1">&#39;&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;a href=&quot;#&#39;</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>Some link<span class="nt">&lt;/a&gt;</span>
</pre></div>
</div>
<p>Which produces:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;%22%3E%3Cscript%3Ealert%281%29%3C%2Fscript%3E%3Ca%20href%3D%22%23&quot;</span><span class="nt">&gt;</span>Some link<span class="nt">&lt;/a&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="escaping-css">
<h2>Escaping CSS<a class="headerlink" href="#escaping-css" title="Ссылка на этот заголовок">¶</a></h2>
<p>CSS identifiers/values can be escaped too:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">style=</span><span class="s">&quot;color: Escape unstrusted data here&quot;</span><span class="nt">&gt;</span>Some link<span class="nt">&lt;/a&gt;</span>
</pre></div>
</div>
<p>You can escape an HTML attribute by using the escapeCss method:</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">style=</span><span class="s">&quot;color: </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">escapeCss</span><span class="p">(</span><span class="s1">&#39;&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;a href=&quot;#&#39;</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>Some link<span class="nt">&lt;/a&gt;</span>
</pre></div>
</div>
<p>Which produces:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">style=</span><span class="s">&quot;color: \22 \3e \3c script\3e alert\28 1\29 \3c \2f script\3e \3c a\20 href\3d \22 \23 &quot;</span><span class="nt">&gt;</span>Some link<span class="nt">&lt;/a&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="escaping-javascript">
<h2>Escaping Javascript<a class="headerlink" href="#escaping-javascript" title="Ссылка на этот заголовок">¶</a></h2>
<p>Strings to be inserted into javascript code also must be properly escaped:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;script&gt;</span><span class="nb">document</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s1">&#39;Escape unstrusted data here&#39;</span><span class="nt">&lt;/script&gt;</span>
</pre></div>
</div>
<p>You can escape an HTML attribute by using the escapeJs method:</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="nt">&lt;script&gt;</span><span class="nb">document</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">escapejs</span><span class="p">(</span><span class="s2">&quot;&#39;; alert(100); var x=&#39;&quot;</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="s1">&#39;</span><span class="nt">&lt;/script&gt;</span>
</pre></div>
</div>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;script&gt;</span><span class="nb">document</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s1">&#39;\x27; alert(100); var x\x3d\x27&#39;</span><span class="nt">&lt;/script&gt;</span>
</pre></div>
</div>
</div>
</div>


</div>